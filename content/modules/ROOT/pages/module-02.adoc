:imagesdir: ../assets/images
== Module 2: The Review Processor Agentic App

Objective: Implement and deploy the first AI agent, which is a Java-based, multi-step orchestration application running on Quarkus.


== User flow:

image:m2/review-processor-diagram.png[Review Processor Agent Diagram]

Here is an overview of the user flow:

* The reviews submitted by users via the front-end application are published to the `review-intake` Kafka topic.
* The Review Processor Agent consumes the events from the `review-intake` topic.
* The agent then uses LangGraph4j to *orchestrate a multi-step workflow* as shown in the diagram above: 
1. Moderate the review
2. Perform Sentiment Analysis using another LLM 
3. Fetch user data from an internal API
4. Generate a personalized thank-you email using an LLM 
5. Send the email via the MCP Mail Server (secured with OIDC/OAuth from Keycloak) 
6. Persist the moderated review and sentiment score to MongoDB.
* Finally, the processed review event is published to the `review-processed` Kafka topic for downstream which is the Review Summary Agent.


NOTE: LangGraph is a library for develop AI Agentic Architectures in the Java ecosystem and works seamlessly with both Langchain4j

NOTE: MCP (Model Context Protocol) is an open standard for AI to connect with external tools and data 



== Technical Context:

=== Processor Agent Implementation

The Review Processor Agentic app has a number of tasks that needs to be executed. Agentic apps often need some orchestration between LLM calls to API calls and other activities. This could be dnone a few different ways

One option is to leave the orchestration almost entirely to the LLM itself by building autonomous agents which make decisions in terms of which step to execute next based on results from the current step. This can be quite brittle in reality.

The other options is to build a more static kind of workflow and this is what is being done here with LangGraph4j. There are several discrete steps in the workflow - some of which require a call to LLM for Moderation or Sentiment Analysis, and  API calls to a backend service to fetch the user data, and also write a confirmation email using an LLM.

In the next section, you will walk through the implementation of this agentic app and understand how the different steps are implemented and orchestrated using LangGraph4j.


=== MCP Mail Server 

The MCP server  has also been implemented with Quarkus and secured with OAuth using Keycloak. The integration with Keycloak for secure communication with the MCP Mail Server demonstrates best practices in securing AI workflows in enterprise environments.

== Activity walk through:

=== Submit a review via the Globex Web Application

. Login to the OpenShift cluster and navigate to the `globex-ai` project/namespace.
. Navigate to the Routes menu, and open the `globex-web` route to access the webpage
+
image:m2/globex-web-route.png[Globex Web]

. Login as *asilva* and password as *openshift*.
+
image:m2/globex-web-login.png[Globex Web, width=400]

. Click on the *Cool Stuff Store* menu on top, and click on any of the products. 
+
NOTE: Navigating to page 7 has some seriously cool gear!!  
+
image:m2/globex-web-page7.png[Globex Web, width=400]
. Choose the *Millenium 5A Maple Drumsticks* for example, and submit a review such as *These drumsticks are awesome! They have great balance and durability. Highly recommend for any drummer.*, and choose a rating of 5 stars. Then click on *Submit Review* button.
+
image:m2/globex-web-maple5a.png[Globex Web, width=400]

. You will see a confirmation message that your review has been submitted.
. In a few seconds you will se the review appear on the page under the  *Customer Reviews* section. 
+
image:m2/globex-web-maple5a-reviewsubmitted.png[Globex Web, width=400]
+
NOTE: You will only this review only if it were not abusive! :) 

== Explore the workflow with the Kafka console

. In the OpenShift console, navigate to the *kafka* project/namespace. From the Routes menu, launch the Kafka Console, and login anonmously.
+
image:m2/kafka-console.png[Kafka Console]
. In the Kafka Console, click on the *Topics* menu, and then click on the *review-intake* topic. Note that the message that you just submitted from the web application is visible here.
+
image:m2/reviews-intake.png[]

. The `review-service` (https://github.com/globex-ai/review-service[source code^]) in the `globex-ai` namespace has consumed your review published it to the `review-intake` topic. 
+
[NOTE] 
====
With Quarkus, writing to Kafka is super simple. You can declare the Kafka topc as the Channel, and emit messages to Kafka with a single line of code as show in the snippet below of https://github.com/globex-ai/review-service/blob/main/src/main/java/org/globex/retail/ai/review/service/KafkaService.java[KafkaService class^]:

```java
    @Inject
    @Channel("review")
    Emitter<String> emitter;

    public void emit(String key, String payload) {
        emitter.send(toMessage(key, payload));
    }
```
====

. Next, the https://github.com/globex-ai/review-processor/blob/main/src/main/java/org/globex/retail/ai/RecordConsumer.java#L34-L36[`review-processor`^] agentic app kicks in and consumes this Kafka record.

+
[NOTE]
==== 
This is done easily with just an annotation as shown below:

```java
    @Incoming("intake")
    @Acknowledgment(Acknowledgment.Strategy.PRE_PROCESSING)
    public Uni<Void> consume(Record<String, String> record) {
        LOGGER.info("Received message with key:{}", record.key());
    }
```
The `@Incoming("intake")` annotation indicates that this method will consume messages from the `review-intake` Kafka topic (the channel name is mapped to the topic name in the application configuration). 

All messages received by a consumer must be acknowledged - otherwise he processing is considered in error. The `@Acknowledgment` annotation specifies the acknowledgment strategy for message processing.  Learn more : https://quarkus.io/guides/kafka#message-acknowledgment[Kafka Acknowledgment Strategies^].
====

. LangGraph4j Workflow: Identify the implementation of the orchestration workflow. This workflow includes:
.. LLM Calls: For Moderation and Sentiment Analysis.
.. API Calls: To an internal back-end to Fetch User Data.
.. Email Generation: An LLM call to draft the personalized thank-you email.
Secure Communication: Using the MCP server (secured with OIDC/OAuth from Keycloak) to send the email.

. Finally, the processed review is published to the `review-processed` Kafka topic for downstream consumption by the Review Summary Agent.
